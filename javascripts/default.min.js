function is_defined(e){return"undefined"!=typeof e}function save_cookies(){$.cookie("from",from.getText()),$.cookie("to",to.getText()),$.cookie("when",$("#when").prop("value"))}function load_cookies(){$.cookie.defaults.expires=365,$.cookie.defaults.path="/",from.setText($.cookie("from")),to.setText($.cookie("to")),$("#when").prop("value",$.cookie("when"))}function str2date(e){var t=e.split(":").map(function(e){return parseInt(e)}),r=new Date;return r.setHours(t[0],t[1],t[2]),r}function date2str(e){return[e.getHours().toString().rjust(2,"0"),e.getMinutes().toString().rjust(2,"0")].join(":")}function time_relative(e,t){return Math.round((t-e)/1e3/60)}function is_now(){return"now"===$("#when").prop("value")}function get_trip_match_regexp(){if(!is_now()){var e=$("#when").prop("value");return e=e.charAt(0).toUpperCase()+e.substring(1),new RegExp(e,"i")}var t=new Date;switch(t.getDay()){case 1:case 2:case 3:case 4:case 5:return/Weekday/i;case 6:return/Saturday/i;case 0:return/Sunday/i;default:return void alert("now_date.getDay() got wrong: "+t.getDay())}}function compare_trip(e,t){return e.departure_time-t.departure_time}function get_trips(e,t,r){var i=[],n=get_trip_match_regexp();for(var a in e)if(n.exec(a)){var o=e[a],s=void 0,c=void 0;t.forEach(function(e){is_defined(o[e])&&(s=o[e])}),r.forEach(function(e){is_defined(o[e])&&(c=o[e])}),is_defined(s)&&is_defined(c)&&s.stop_sequence<c.stop_sequence&&(!is_now()||s.departure_time>new Date)&&i.push({departure_time:s.departure_time,arrival_time:c.arrival_time})}return i.sort(compare_trip)}function render_info(e){var t=$("#info").empty();if(is_now()&&is_defined(e)){var r=time_relative(new Date,e.departure_time);t.append('<div class="info">Next train: '+r+"min</div>")}}function render_result(e){var t=$("#result").empty();e.forEach(function(e){var r=date2str(e.departure_time),i=date2str(e.arrival_time),n=time_relative(e.departure_time,e.arrival_time);t.append('<div class="trip">'+r+" => "+i+" ("+n+"min)</div>")})}function schedule(e){var t=e.data.cities,r=e.data.services,i=t[from.getText()],n=t[to.getText()];if(i&&n){var a=get_trips(r,i,n);save_cookies(),render_info(a[0]),render_result(a)}}function bind_events(e){var t={data:e};[from,to].forEach(function(e){var r=$('<span class="cancel">x</span>').on("click",function(){e.setText(""),e.input.focus()}),i=function(){""==e.input.value?r.hide():r.show(),schedule(t)};e.on("change",i),e.on("complete",i),$(e.wrapper).append(r)}),$("#when").on("change",e,schedule),$("#reverse").on("click",e,function(e){var t=from.getText();from.setText(to.getText()),to.setText(t),schedule(e)})}function initialize(e){var t=e.stops,r=e.times,i={};t.forEach(function(e){var t=e.stop_id,r=e.stop_name;is_defined(i[r])?i[r].push(t):i[r]=[t]});var n=Object.keys(i);from.setOptions(n),to.setOptions(n);var a={};r.forEach(function(e){var t=e.trip_id;is_defined(a[t])||(a[t]={}),a[t][e.stop_id]={departure_time:str2date(e.departure_time),arrival_time:str2date(e.arrival_time),stop_sequence:e.stop_sequence}});var e={cities:i,services:a};load_cookies(),bind_events(e),schedule({data:e})}function data_checker(e,t){var r={},i={},t=t;return e.forEach(function(e){r[e]=!1}),function(e,n){r[e]=!0,i[e]=n;var a=!0;for(var o in r)r[o]||(a=!1);a&&t(i)}}var from,to;String.prototype.repeat=function(e){for(var t=0,r="";e>t;t++)r+=this;return r},String.prototype.rjust=function(e,t){return t=t||" ",t=t.substr(0,1),this.length<e?t.repeat(e-this.length)+this:this},$(function(){FastClick.attach(document.body)}),$(document).ready(function(){var e=data_checker(["stops","times"],initialize);from=rComplete($("#from")[0],{placeholder:"Departure"}),to=rComplete($("#to")[0],{placeholder:"Destination"}),Papa.parse("data/stops.csv",{download:!0,dynamicTyping:!0,header:!0,complete:function(t){e("stops",t.data)}}),Papa.parse("data/times.csv",{download:!0,dynamicTyping:!0,header:!0,complete:function(t){e("times",t.data)}})});